name: X10Hosting Keep Alive

on:
  schedule:
    - cron: '0 */1 * * *'  # æ¯å°æ—¶è¿è¡Œï¼ˆCookie 2å°æ—¶è¿‡æœŸï¼Œç•™ä½™é‡ï¼‰
  workflow_dispatch:

env:
  SERVICE_ID: "175344"

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    
    steps:
      - name: ä¸‹è½½ Hysteria2
        run: |
          wget -q https://github.com/apernet/hysteria/releases/latest/download/hysteria-linux-amd64 -O hysteria
          chmod +x hysteria

      - name: é…ç½®å¹¶å¯åŠ¨ä»£ç†
        env:
          HY2_URL: ${{ secrets.HY2_URL_JP }}
        run: |
          URL_BODY="${HY2_URL#hysteria2://}"
          URL_BODY="${URL_BODY%%#*}"
          PASSWORD="${URL_BODY%%@*}"
          SERVER_PART="${URL_BODY#*@}"
          SERVER="${SERVER_PART%%\?*}"
          PARAMS="${SERVER_PART#*\?}"
          
          get_param() { echo "$PARAMS" | tr '&' '\n' | grep "^$1=" | cut -d'=' -f2; }
          SNI=$(get_param "sni")
          INSECURE=$(get_param "insecure")
          [ -z "$SNI" ] && SNI="${SERVER%%:*}"
          [ "$INSECURE" = "1" ] && INSECURE="true" || INSECURE="false"
          
          cat > hy2-config.yaml << EOF
          server: ${SERVER}
          auth: ${PASSWORD}
          tls:
            sni: ${SNI}
            insecure: ${INSECURE}
          socks5:
            listen: 127.0.0.1:1080
          http:
            listen: 127.0.0.1:8080
          EOF
          
          ./hysteria client -c hy2-config.yaml &
          sleep 3
          
          echo "ğŸŒ ä»£ç† IP: $(curl -s --proxy socks5h://127.0.0.1:1080 https://api.ipify.org)"

      - name: è®¿é—®é¢æ¿å¹¶åˆ·æ–° Cookie
        env:
          X10_SESSION: ${{ secrets.X10_SESSION }}
          X10_XSRF: ${{ secrets.X10_XSRF }}
          REPO_TOKEN: ${{ secrets.REPO_TOKEN }}
          GITHUB_REPO: ${{ github.repository }}
          SERVICE_ID: ${{ env.SERVICE_ID }}
        run: |
          # åˆ›å»º cookie æ–‡ä»¶
          COOKIE_FILE=$(mktemp)
          
          # å†™å…¥ç°æœ‰ Cookie
          cat > "$COOKIE_FILE" << EOF
          x10hosting.com	FALSE	/	TRUE	0	XSRF-TOKEN	${X10_XSRF}
          x10hosting.com	FALSE	/	TRUE	0	x10hosting_session	${X10_SESSION}
          EOF
          
          echo "ğŸ“ è®¿é—®æœåŠ¡é¢æ¿..."
          
          # ä½¿ç”¨ curl è®¿é—®å¹¶è·å–æ–° Cookie
          RESPONSE=$(curl -sS -w "\n%{http_code}" \
            --proxy socks5h://127.0.0.1:1080 \
            -L \
            -c "$COOKIE_FILE" \
            -b "$COOKIE_FILE" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36" \
            -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8" \
            -H "Accept-Language: zh-CN,zh;q=0.9,en;q=0.8" \
            -H "Referer: https://x10hosting.com/panel" \
            "https://x10hosting.com/panel/services/${SERVICE_ID}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP çŠ¶æ€ç : $HTTP_CODE"
          
          # æ£€æŸ¥æ˜¯å¦è¢«é‡å®šå‘åˆ°ç™»å½•é¡µ
          if echo "$BODY" | grep -qiE "(login|sign.?in|recaptcha|Log In)"; then
            echo "âŒ Cookie å·²è¿‡æœŸï¼Œéœ€è¦æ‰‹åŠ¨é‡æ–°è·å–"
            echo ""
            echo "è¯·ä½¿ç”¨ç›¸åŒä»£ç†åœ¨æµè§ˆå™¨ç™»å½•åæ›´æ–°ä»¥ä¸‹ Secrets:"
            echo "  - X10_SESSION"
            echo "  - X10_XSRF"
            exit 1
          fi
          
          # æå–é¡µé¢æ ‡é¢˜
          TITLE=$(echo "$BODY" | grep -oP '(?<=<title>).*?(?=</title>)' | head -1)
          echo "ğŸ“„ é¡µé¢æ ‡é¢˜: $TITLE"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… è®¿é—®æˆåŠŸï¼"
            
            # è¯»å–æ–° Cookie
            NEW_SESSION=$(grep "x10hosting_session" "$COOKIE_FILE" | awk '{print $NF}')
            NEW_XSRF=$(grep "XSRF-TOKEN" "$COOKIE_FILE" | awk '{print $NF}')
            
            echo ""
            echo "ğŸ”„ æ£€æŸ¥ Cookie æ›´æ–°..."
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
            NEED_UPDATE=false
            
            if [ -n "$NEW_SESSION" ] && [ "$NEW_SESSION" != "$X10_SESSION" ]; then
              echo "  X10_SESSION: éœ€è¦æ›´æ–°"
              NEED_UPDATE=true
            else
              echo "  X10_SESSION: æœªå˜åŒ–"
            fi
            
            if [ -n "$NEW_XSRF" ] && [ "$NEW_XSRF" != "$X10_XSRF" ]; then
              echo "  X10_XSRF: éœ€è¦æ›´æ–°"
              NEED_UPDATE=true
            else
              echo "  X10_XSRF: æœªå˜åŒ–"
            fi
            
            # æ›´æ–° GitHub Secrets
            if [ "$NEED_UPDATE" = true ]; then
              echo ""
              echo "ğŸ“¤ æ›´æ–° GitHub Secrets..."
              
              # è·å–ä»“åº“å…¬é’¥
              KEY_RESPONSE=$(curl -s \
                -H "Authorization: Bearer ${REPO_TOKEN}" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/${GITHUB_REPO}/actions/secrets/public-key")
              
              PUBLIC_KEY=$(echo "$KEY_RESPONSE" | grep -o '"key":"[^"]*"' | cut -d'"' -f4)
              KEY_ID=$(echo "$KEY_RESPONSE" | grep -o '"key_id":"[^"]*"' | cut -d'"' -f4)
              
              if [ -z "$PUBLIC_KEY" ]; then
                echo "âŒ è·å–å…¬é’¥å¤±è´¥: $KEY_RESPONSE"
                exit 1
              fi
              
              # å®‰è£…åŠ å¯†å·¥å…·
              pip install pynacl -q
              
              # æ›´æ–° X10_SESSION
              if [ -n "$NEW_SESSION" ] && [ "$NEW_SESSION" != "$X10_SESSION" ]; then
                ENCRYPTED=$(python3 << PYTHON
          from base64 import b64encode
          from nacl import encoding, public
          
          public_key = public.PublicKey(b"${PUBLIC_KEY}".encode(), encoding.Base64Encoder)
          sealed_box = public.SealedBox(public_key)
          encrypted = sealed_box.encrypt(b"${NEW_SESSION}")
          print(b64encode(encrypted).decode())
          PYTHON
          )
                
                curl -s -X PUT \
                  -H "Authorization: Bearer ${REPO_TOKEN}" \
                  -H "Accept: application/vnd.github+json" \
                  -d "{\"encrypted_value\":\"${ENCRYPTED}\",\"key_id\":\"${KEY_ID}\"}" \
                  "https://api.github.com/repos/${GITHUB_REPO}/actions/secrets/X10_SESSION"
                
                echo "  âœ… X10_SESSION å·²æ›´æ–°"
              fi
              
              # æ›´æ–° X10_XSRF
              if [ -n "$NEW_XSRF" ] && [ "$NEW_XSRF" != "$X10_XSRF" ]; then
                ENCRYPTED=$(python3 << PYTHON
          from base64 import b64encode
          from nacl import encoding, public
          
          public_key = public.PublicKey(b"${PUBLIC_KEY}".encode(), encoding.Base64Encoder)
          sealed_box = public.SealedBox(public_key)
          encrypted = sealed_box.encrypt(b"${NEW_XSRF}")
          print(b64encode(encrypted).decode())
          PYTHON
          )
                
                curl -s -X PUT \
                  -H "Authorization: Bearer ${REPO_TOKEN}" \
                  -H "Accept: application/vnd.github+json" \
                  -d "{\"encrypted_value\":\"${ENCRYPTED}\",\"key_id\":\"${KEY_ID}\"}" \
                  "https://api.github.com/repos/${GITHUB_REPO}/actions/secrets/X10_XSRF"
                
                echo "  âœ… X10_XSRF å·²æ›´æ–°"
              fi
            fi
            
            echo ""
            echo "ğŸ‰ å®Œæˆï¼"
          else
            echo "âŒ è®¿é—®å¤±è´¥ (HTTP $HTTP_CODE)"
            exit 1
          fi
          
          rm -f "$COOKIE_FILE"
